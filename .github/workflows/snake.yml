name: Angelcore Commit Animation

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *"  # runs daily

permissions:
  contents: write

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install dependencies
        run: |
          npm install canvas gifencoder

      - name: Generate angelcore animation
        run: |
          node - << 'EOF'
          const { createCanvas } = require('canvas');
          const GIFEncoder = require('gifencoder');
          const fs = require('fs');

          const width = 800;
          const height = 200;
          const encoder = new GIFEncoder(width, height);
          encoder.createReadStream().pipe(fs.createWriteStream('dist/angelcore.gif'));
          encoder.start();
          encoder.setRepeat(0);
          encoder.setDelay(100);
          encoder.setQuality(10);

          // generate 20 frames
          for(let frame=0; frame<20; frame++){
            const canvas = createCanvas(width, height);
            const ctx = canvas.getContext('2d');

            // background
            ctx.fillStyle = 'lavenderblush';
            ctx.fillRect(0,0,width,height);

            // draw drifting feathers
            for(let i=0; i<15; i++){
              const x = Math.random() * width;
              const y = ((Math.random() * height) + frame*5) % height; // drift down
              const size = 10 + Math.random()*20;
              ctx.fillStyle = 'rgba(255,255,255,0.5)';
              ctx.beginPath();
              ctx.ellipse(x, y, size, size/2, 0, 0, 2*Math.PI);
              ctx.fill();
            }

            encoder.addFrame(ctx);
          }
          encoder.finish();
          EOF

      - name: Push to output branch
        uses: crazy-max/ghaction-github-pages@v3
        with:
          target_branch: output
          build_dir: dist
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
